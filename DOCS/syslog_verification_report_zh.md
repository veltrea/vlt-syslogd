# Syslog 验证最终报告：实际工具中的编码行为

## 1. 验证目的
证明 RFC 5424 规范（UTF-8 时必须包含 BOM）与实际 Syslog 发送工具行为之间的差异，并确认所实现的“宽容解析 (Tolerant Parsing)”的有效性。

## 2. 验证环境
- **服务器**: `vlt-syslog-portable` (Mac 192.168.1.22)
- **客户端 1 (Mac)**: `nc` (netcat), `logger`
- **客户端 2 (Windows)**: `LLM-SVR1` (PowerShell .NET)

## 3. 验证结果：实际设备的“原始数据”分析

记录在 `logs/debug_raw.log` 中的接收数据包 (HEX) 的分析结果。

| 发送工具 / 格式 | 预期行为 (RFC) | 实际行为 (RAW) | 判定结果 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **Mac `nc` (UTF-8)** | 有 BOM | **无 BOM** | ✅ UTF-8 (隐式) | 即使手动发送，遗漏 BOM 的情况也很常见 |
| **Windows PowerShell** | 有 BOM | **无 BOM** | ✅ UTF-8 (隐式) | 确认受 .NET 标准行为影响而缺失 BOM |
| **MegaLog / 各种 SD** | 按指定 | 按指定 | ✅ 各种字符集 | SD `charset` 参数具有极高的可靠性 |
| **Legacy (RFC 3164)** | 无规定 | 无 BOM (SJIS等) | ✅ Shift_JIS/GBK (判定) | 通过统计推测正确还原 CJK 字符 |

## 4. 关于“BOM 陷阱”的考察与解决方案
通过本次验证，明确了 **“仅依靠 BOM 是否存在来解析在现实世界中是行不通的”**。

### 现状
- 在 Windows 的标准发送（如 PowerShell）中，即使是 UTF-8 通常也不带 BOM。
- 如果将其视为“没有 BOM 所以是乱码（或无效数据）”，现代系统的日志将全部显示乱码。

### 我们的解决方案（三层逻辑）
1. **BOM 检测**: 如果存在，则 100% 视为 UTF-8。
2. **SD (Structured Data) 解析**: 分析 `charset` 标签（`UTF-8`, `MSG-UTF8`, `Shift_JIS` 等）进行还原。
3. **统计推定 (最后防线)**: 通过 `chardetng` 根据字节序列特征为中日韩环境做出最优判定。

## 5. 结论
事实证明，`vlt-syslog-portable` 在尊重 RFC 理想的同时，对现实世界中的“不完全数据”具有极高的适应性。这使得在多平台混合环境中也能实现无乱码的稳定日志监控。

---

> [!IMPORTANT]
> **致全球用户的一封信**
> 目前开发者的测试环境**仅限于日语环境**。虽然我们已经确认了对主要编码的支持，但如果您在所在地区（中文、英文、韩文、越南语等）遇到显示问题或“乱码”，请务必向我们报告。期待您的反馈！
